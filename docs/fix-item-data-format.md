# アイテムデータ形式の修正手順

## 問題の説明

一部のキャラクターのアイテムデータが以下のような文字列配列形式で保存されています:

```json
{
  "items": ["5", "10"]  // 間違った形式
}
```

正しい形式は以下の通りです:

```json
{
  "items": [
    { "itemId": 5, "isVirtual": false },
    { "itemId": 10, "isVirtual": false }
  ]
}
```

## 対応内容

### 1. マイグレーション機能の強化 (完了)

`src/utils/itemMigration.js`を修正して、文字列配列にも対応:

- `isOldFormat()`: 文字列配列も旧形式として判定
- `migrateToNewFormat()`: 文字列を数値に変換し、新形式に変換

### 2. 自動修正

データベースから読み込み時に、`database.js`の`loadAndProcessInitialData()`内で自動的に新形式に変換されます:

```javascript
const migratedItems = ensureNewFormat(data.items);
```

これにより、文字列配列`["5", "10"]`は自動的に以下に変換されます:

```javascript
[
  { itemId: 5, isVirtual: false },
  { itemId: 10, isVirtual: false }
]
```

### 3. データベースの恒久的修正

アイテムを更新すると、正しい形式でデータベースに保存されます。

**手動での一括修正が必要な場合:**

1. **アイテム管理タブ**を開く
2. 問題のあるキャラクターを選択
3. アイテムを再度選択（変更なしでもOK）
4. 「アイテムを更新」ボタンをクリック

これで、データベースに正しい形式で保存されます。

## テスト結果

すべてのテストがパス（26/26）:
- 文字列配列の検出
- 文字列から数値への変換
- 新形式への変換
- 無効な値のフィルタリング

## 影響範囲

以下のコンポーネントが修正済み:
- ✅ `ManageItemsTab.vue` (アイテム管理タブ)
- ✅ `TeamList.vue` (チーム一覧)
- ✅ `formatters.js` (表示用フォーマッター)
- ✅ `itemMigration.js` (マイグレーション処理)

## 今後の予防策

新規キャラクター追加時は、すでに正しい形式（空配列`[]`）で保存されるため、新たに文字列配列が作成されることはありません。

## トラブルシューティング

### 問題: アイテムが表示されない

**原因**: 文字列配列が正しく変換されていない

**解決方法**:
1. ブラウザのコンソールで警告を確認
2. アイテム管理タブで該当キャラクターのアイテムを更新

### 問題: 無効なアイテムIDエラー

**原因**: データベースに無効な文字列（"invalid"など）が保存されている

**解決方法**:
1. コンソールに`Invalid item ID detected: <value>`と表示される
2. 該当キャラクターのアイテムを手動で修正
